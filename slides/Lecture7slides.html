<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Lea.orange[R]ning about Statistics</title>
    <meta charset="utf-8" />
    <meta name="author" content="Zachary Thompson" />
    <meta name="date" content="2022-07-12" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/tile-view/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view/tile-view.js"></script>
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <link rel="stylesheet" href="css/moffitt-xaringan.css" type="text/css" />
    <link rel="stylesheet" href="css/moffitt-xaringan-extra.css" type="text/css" />
    <link rel="stylesheet" href="css/tachyons.moffitt.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">




name: title
class: left bottom hide-count

&lt;!-- Slide Extras --&gt;






&lt;!-- Title Slide --&gt;
&lt;!-- &lt;div class="talk-logo"&gt;&lt;/div&gt; --&gt;

.talk-meta[
.talk-title[
# Lea.orange[R]ning about Statistics

Tables, Chi Square and Fisher's exact test, KM curves and log rank tests
]

.talk-author[
Zachary Thompson&lt;br&gt;
.moffitt-gray[Moffitt Cancer Center]
]

.talk-date.moffitt-gray[
July 12, 2022
]
]


&lt;style type="text/css"&gt;
/* Define title slide image or logo here */
.talk-logo {
  width: 400px;
  height: 750px;
  position: absolute;
  top: 6%;
  right: 7%;
  /* background-image: url('img/r4ds-cover.png'); */
  background-size: contain;
  background-repeat: no-repeat;
  background-position: contain;
}
&lt;/style&gt;

&lt;!-- Moffitt Logo and Slide Border ----

All slides except "title" and "inverse" slides
have the Moffitt Color Bar and logo.

Additional classes are provided to disable both:

- `class: no-logo` hides the logo
- `class: no-border` hides the border

or to force either to be shown

- `class: moffitt-slide-logo` shows the logo
- `class: moffitt-slide-border` shows the border
--&gt;

---

## What you will learn to run
 
  
- Review of tables with janitor package
  
- Chi Square and Fisher’s Exact test

- Kaplan-Meier Curves and estimates

- Log rank tests


---
 
## Data prep: location use here()
 


```r
 here()
```

```
[1] "F:/myGitRepo/Intro_to_R_2022"
```

```r
 here("data","tcga-clinical.txt")
```

```
[1] "F:/myGitRepo/Intro_to_R_2022/data/tcga-clinical.txt"
```

```r
 here("data","tcga-gene-exp.txt")
```

```
[1] "F:/myGitRepo/Intro_to_R_2022/data/tcga-gene-exp.txt"
```

---
 
## Data prep: load
 


```r
clinical &lt;- read.csv(file = here("data","tcga_clinical.txt"),
                     header = TRUE)
geneexp &lt;- read.csv(file = here("data","tcga_gene_exp.txt"),
                    header = TRUE)
```





---
 
## Data prep: merge
 


```r
  tcga &lt;- left_join(clinical, geneexp, by = "bcr_patient_barcode")

     intersect(names(clinical), names(geneexp))
```

```
[1] "bcr_patient_barcode"
```

```r
     dim(tcga) 
```

```
[1] 1043   33
```



---



## Data prep: mutate
 


```r
  tcga &lt;- tcga %&gt;% mutate( 
  smoking = case_when(
    tobacco_smoking_history %in% c(
      "Current reformed smoker for &lt; or = 15 years",
      "Current reformed smoker for &gt; 15 years",
      "Current Reformed Smoker, Duration Not Specified"
    ) ~ "Former",
    tobacco_smoking_history %in% c("Current smoker") ~ "Current",
    tobacco_smoking_history %in% c("Lifelong Non-smoker") ~ "Never",
    is.na(tobacco_smoking_history) ~ NA_character_
  )
)
```




---

## Review of tables
 


```r
janitor::tabyl(tcga, radiation_therapy, vital_status )
```

```
 radiation_therapy Alive Dead
                NO   217   84
               YES   190   95
              &lt;NA&gt;   243  214
```
 
 
---

## Review of tables
 


```r
janitor::tabyl(tcga, radiation_therapy, vital_status, 
               show_na = FALSE )
```

```
 radiation_therapy Alive Dead
                NO   217   84
               YES   190   95
```

---

## Review of tables

```r
tcga %&gt;% 
  tabyl(smoking, gender, show_na = FALSE )
```

```
 smoking FEMALE MALE
 Current     40  151
  Former     54  180
   Never     72   88
```

---

## Review of tables

```r
tcga %&gt;% 
  tabyl(smoking, gender, show_na = FALSE ) %&gt;% 
  adorn_totals(where = c("row"))
```

```
 smoking FEMALE MALE
 Current     40  151
  Former     54  180
   Never     72   88
   Total    166  419
```

---

## Review of tables

```r
tcga %&gt;% 
  tabyl(smoking, gender, show_na = FALSE ) %&gt;% 
  adorn_totals(where = c("col"))
```

```
 smoking FEMALE MALE Total
 Current     40  151   191
  Former     54  180   234
   Never     72   88   160
```



---

## Review of tables

```r
tcga %&gt;% 
  tabyl(smoking, gender, show_na = FALSE ) %&gt;% 
  adorn_totals(where = c("row","col"))
```

```
 smoking FEMALE MALE Total
 Current     40  151   191
  Former     54  180   234
   Never     72   88   160
   Total    166  419   585
```

---

## Review of tables

```r
tcga %&gt;% 
  tabyl(smoking, gender, show_na = FALSE ) %&gt;% 
  adorn_totals(where = c("row","col")) %&gt;% 
  adorn_percentages(denominator = "col") 
```

```
 smoking    FEMALE      MALE     Total
 Current 0.2409639 0.3603819 0.3264957
  Former 0.3253012 0.4295943 0.4000000
   Never 0.4337349 0.2100239 0.2735043
   Total 1.0000000 1.0000000 1.0000000
```

---

## Review of tables

```r
tcga %&gt;% 
  tabyl(smoking, gender, show_na = FALSE ) %&gt;% 
  adorn_totals(where = c("row","col")) %&gt;% 
  adorn_percentages(denominator = "col") %&gt;% 
  adorn_pct_formatting(digits = 0)  
```

```
 smoking FEMALE MALE Total
 Current    24%  36%   33%
  Former    33%  43%   40%
   Never    43%  21%   27%
   Total   100% 100%  100%
```

---

## Review of tables

```r
tcga %&gt;% 
  tabyl(smoking, gender, show_na = FALSE ) %&gt;% 
  adorn_totals(where = c("row","col")) %&gt;% 
  adorn_percentages(denominator = "col") %&gt;% 
  adorn_pct_formatting(digits = 0) %&gt;% 
  adorn_ns(position = "front") 
```

```
 smoking     FEMALE       MALE      Total
 Current  40  (24%) 151  (36%) 191  (33%)
  Former  54  (33%) 180  (43%) 234  (40%)
   Never  72  (43%)  88  (21%) 160  (27%)
   Total 166 (100%) 419 (100%) 585 (100%)
```

 
 
---


# Pearson’s chi-squared test
 
The chi squared test is a non-parametric test that can be applied to contingency tables with various dimensions. The name of the test originates from the chi-squared distribution, which is the distribution for the squares of independent standard normal variables. This is the distribution of the test statistic of the chi squared test, which is defined by the sum of chi-square values for all cells arising from the difference between a cell’s observed value and the expected value, normalized by the expected value.
 
`\(\chi ^{2}\)` = `\(\sum_{ij}\)` `\(\frac{(O_{ij} - E_{ij})^{2}}{E_{ij}}\)` 


*   `\(\chi ^{2}\)` = chi square statistic
*   `\(O_{ij}\)` = observed value
*   `\(E_{ij}\)` = expected value


---
## Pearson’s chi-squared test
 
The null hypothesis of the Chi-Square test is that no relationship exists between the categorical variables in the population; they are independent.

 

```
 smoking     FEMALE       MALE      Total
 Current  40  (24%) 151  (36%) 191  (33%)
  Former  54  (33%) 180  (43%) 234  (40%)
   Never  72  (43%)  88  (21%) 160  (27%)
   Total 166 (100%) 419 (100%) 585 (100%)
```
 


---

## Pearson’s chi-squared test
 
The null hypothesis of the Chi-Square test is that no relationship exists between the categorical variables in the population; they are independent.

 


```r
tcga %&gt;% tabyl( smoking, gender , show_na = FALSE ) %&gt;%
  chisq.test()
```

```

	Pearson's Chi-squared test

data:  .
X-squared = 30.182, df = 2, p-value = 0.0000002793
```
 
The p-value is very low so we reject the null hypothesis that there is no association between the variables. 

---

## Pearson’s chi-squared test
 
  More women are never smokers and more men are current smokers. 
 
.panelset[
.panel[.panel-name[R Code]


```r
ggplot(tcga %&gt;% filter(!is.na(smoking)),
       aes(x = gender, fill = smoking )) +  
  geom_bar(position = "fill") +
  labs(y = "proportion")
```
]

.panel[.panel-name[Plot]

&lt;img src="Lecture7slides_files/figure-html/unnamed-chunk-15-1.png" width="100%" /&gt;
]
]
 


---

# Fisher’s Exact test
 
Similar to Chi square test. Use the Fisher's exact test of independence when you have two nominal variables and you want to see whether the proportions of one variable are different depending on the value of the other variable. Use it when the sample size is small.


How the test works:

Unlike most statistical tests, Fisher's exact test does not use a mathematical function that estimates the probability of a value of a test statistic; instead, you calculate the probability of getting the observed data, and all data sets with more extreme deviations, under the null hypothesis that the proportions are the same. 


---

## Fisher’s Exact test
 


```r
tcga &lt;- tcga  %&gt;% mutate(Death = ifelse(vital_status == "Dead"," Yes","No"))

tcga %&gt;% filter(race %in% c("ASIAN")) %&gt;% 
  tabyl(gender, Death, show_na = TRUE) %&gt;% 
  adorn_totals(where = c("row","col")) %&gt;% 
  adorn_percentages(denominator = "row") %&gt;% 
  adorn_pct_formatting(digits = 0) %&gt;% 
  adorn_ns(position = "front") 
```

```
 gender     Yes       No     Total
 FEMALE 2 (25%)  6 (75%)  8 (100%)
   MALE 3 (27%)  8 (73%) 11 (100%)
  Total 5 (26%) 14 (74%) 19 (100%)
```

---

## Fisher’s Exact test
  
The null hypothesis is that the relative proportions of one variable are independent of the second variable. For 2 by 2 tables, the null of conditional independence is equivalent to the hypothesis that the odds ratio equals one. 



```r
tcga %&gt;% filter(race %in% c("ASIAN")) %&gt;% 
  tabyl(gender, Death, show_na = TRUE) %&gt;% fisher.test() 
```

```

	Fisher's Exact Test for Count Data

data:  .
p-value = 1
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
  0.05723439 10.70637705
sample estimates:
odds ratio 
 0.8943933 
```
 

 
---

## Fisher's Exact test
   
 
.panelset[
.panel[.panel-name[R Code]


```r
ggplot(tcga %&gt;% filter(race %in% c("ASIAN" )),
       aes(x = gender, fill = Death )) +  
  geom_bar(position = "fill") +
  labs(y = "proportion")
```
]

.panel[.panel-name[Plot]

&lt;img src="Lecture7slides_files/figure-html/unnamed-chunk-16-1.png" width="100%" /&gt;
]
]
 
---
 
# Time to event data - survival data
 
Time-to-event data consist of pairs of observations for each individual: 
- (i) a length of time during which no event was observed 
- (ii) an indicator of whether the end of that time period corresponds to an event or just the end of observation 
 
- Survival ~ event is death (OS)
- Progression free survival ~ event is death or disease progression (PFS)
 
---
 
# Kaplan-Meier estimates and curves
 
The Kaplan–Meier estimator, also known as the product limit estimator, is a non-parametric statistic used to estimate the survival function from time to event data. In medical research, it is often used to measure the fraction of patients living for a certain amount of time after treatment. In other fields, Kaplan–Meier estimators may be used to measure the time-to-failure of machine parts.


 

---

## Kaplan-Meier estimates 
 
The estimator of the survival function: 
 
`\(\hat{S}(t)\)` = `\(\prod_{i:t_{i}&lt;t}\)` `\((1-\frac{d_{i}}{n_{i}})\)` 

*   `\(\hat{S}(t)\)` = probability survival is longer than `\(t\)` 
*   `\(d_{i}\)` = number of deaths (events) that happened at time `\(t_{i}\)` 
*   `\(n_{i}\)` = number of individuals that have survived to time `\(t_{i}\)`




---

## Kaplan-Meier estimates and curves 
 
 

A plot of the Kaplan–Meier estimator is a series of declining horizontal steps which, with a large enough sample size, approaches the true survival function for that population. 

An important advantage of the Kaplan–Meier curve is that the method can take into account some types of censored data, particularly right-censoring, which occurs if a patient withdraws from a study, is lost to follow-up, or is alive without event occurrence at last follow-up. On the plot, small vertical tick-marks state individual patients whose survival times have been right-censored. When no truncation or censoring occurs, the Kaplan–Meier curve is the complement of the empirical distribution function.



---
 
## Kaplan-Meier estimates and curves: Data
 
 
.panelset[
.panel[.panel-name[R Code]


```r
 OSdata &lt;-  data.frame(OStime = tcga$OS.time/365, 
                       Death = I(tcga$vital_status=="Dead"))   
```
]

.panel[.panel-name[R Result]


```r
 head(OSdata, 10) 
```

```
       OStime Death
1  1.05479452 FALSE
2  0.27945205 FALSE
3  0.99178082 FALSE
4  3.06849315 FALSE
5  3.93424658 FALSE
6  0.04383562 FALSE
7  3.26301370  TRUE
8  2.01369863  TRUE
9  4.09041096 FALSE
10 4.08493151 FALSE
```
]


]


---
 
 
 
## Kaplan-Meier estimates and curves: Survival object
 
 
.panelset[
.panel[.panel-name[R Code]


```r
 OS_obj&lt;-survival::Surv(tcga$OS.time/365, I(tcga$vital_status=="Dead"))  
```
]

.panel[.panel-name[R Result]


```r
 head(OS_obj,40) 
```

```
 [1] 1.05479452+ 0.27945205+ 0.99178082+ 3.06849315+ 3.93424658+
 [6] 0.04383562+ 3.26301370  2.01369863  4.09041096+ 4.08493151+
[11] 3.09589041+ 4.13150685+ 4.04931507+ 3.03013699+ 3.24931507+
[16] 3.20547945  3.11506849+ 3.79452055+ 4.44931507+ 4.06849315+
[21] 5.16712329+ 2.58904110+ 0.37534247  4.41095890  3.79452055+
[26] 2.49315068+ 1.53698630  7.36438356+ 3.58082192+ 6.86027397+
[31] 4.27123288+ 0.87397260+ 2.39178082+ 6.21917808+ 6.23013699+
[36] 2.01369863+ 4.44109589+ 3.60000000+ 4.64657534  1.72602740+
```
]


]

---
 
## Kaplan-Meier estimates and curves: Data again
 
 
.panelset[
.panel[.panel-name[R Code]


```r
 OSdata &lt;- bind_cols(OSdata, OS_obj)
```
]

.panel[.panel-name[R Result]


```r
 head(OSdata, 9) 
```

```
      OStime Death       time status
1 1.05479452 FALSE 1.05479452      0
2 0.27945205 FALSE 0.27945205      0
3 0.99178082 FALSE 0.99178082      0
4 3.06849315 FALSE 3.06849315      0
5 3.93424658 FALSE 3.93424658      0
6 0.04383562 FALSE 0.04383562      0
7 3.26301370  TRUE 3.26301370      1
8 2.01369863  TRUE 2.01369863      1
9 4.09041096 FALSE 4.09041096      0
```
]


]


---
 
## Kaplan-Meier estimates and curves: Survfit 
 
 
.panelset[
.panel[.panel-name[R Code]


```r
 kmfit &lt;-  survfit(OS_obj ~ gender, data = tcga)
```
]

.panel[.panel-name[R Result]


```r
 kmfit 
```

```
Call: survfit(formula = OS_obj ~ gender, data = tcga)

   1 observation deleted due to missingness 
                n events median 0.95LCL 0.95UCL
gender=FEMALE 323    133   5.93    4.54    7.54
gender=MALE   719    260   6.18    5.44    7.75
```
]


]



---
 
## Kaplan-Meier estimates and curves: Survfit 
 


```r
 summary(kmfit) 
```

```
Call: survfit(formula = OS_obj ~ gender, data = tcga)

1 observation deleted due to missingness 
                gender=FEMALE 
     time n.risk n.event survival std.err lower 95% CI upper 95% CI
  0.00548    321       1   0.9969 0.00311       0.9908        1.000
  0.06301    313       1   0.9937 0.00444       0.9850        1.000
  0.08767    311       1   0.9905 0.00546       0.9799        1.000
  0.13973    310       1   0.9873 0.00631       0.9750        1.000
  0.15342    309       1   0.9841 0.00705       0.9704        0.998
  0.17534    307       1   0.9809 0.00772       0.9659        0.996
  0.17808    306       1   0.9777 0.00833       0.9615        0.994
  0.18630    305       1   0.9745 0.00890       0.9572        0.992
  0.20000    304       1   0.9713 0.00943       0.9530        0.990
  0.21096    303       1   0.9681 0.00993       0.9488        0.988
  0.24658    302       1   0.9649 0.01040       0.9447        0.985
  0.25753    301       1   0.9617 0.01085       0.9406        0.983
  0.29863    299       1   0.9585 0.01128       0.9366        0.981
  0.38082    295       1   0.9552 0.01170       0.9325        0.978
  0.39452    293       1   0.9519 0.01211       0.9285        0.976
  0.41370    292       1   0.9487 0.01250       0.9245        0.974
  0.45479    290       1   0.9454 0.01287       0.9205        0.971
  0.46849    289       1   0.9421 0.01324       0.9166        0.968
  0.49863    287       1   0.9389 0.01359       0.9126        0.966
  0.50137    286       2   0.9323 0.01427       0.9047        0.961
  0.50685    284       1   0.9290 0.01459       0.9009        0.958
  0.52329    283       1   0.9257 0.01490       0.8970        0.955
  0.53151    282       1   0.9225 0.01521       0.8931        0.953
  0.55342    281       1   0.9192 0.01551       0.8893        0.950
  0.57260    280       1   0.9159 0.01579       0.8854        0.947
  0.58904    279       1   0.9126 0.01607       0.8816        0.945
  0.61370    277       1   0.9093 0.01635       0.8778        0.942
  0.65205    275       1   0.9060 0.01662       0.8740        0.939
  0.66301    274       1   0.9027 0.01689       0.8702        0.936
  0.66575    273       1   0.8994 0.01715       0.8664        0.934
  0.73425    271       1   0.8961 0.01740       0.8626        0.931
  0.75616    270       1   0.8928 0.01765       0.8588        0.928
  0.80548    268       1   0.8894 0.01790       0.8550        0.925
  0.90137    266       1   0.8861 0.01814       0.8512        0.922
  0.91507    265       1   0.8827 0.01838       0.8474        0.919
  0.92055    264       1   0.8794 0.01861       0.8437        0.917
  0.94247    263       1   0.8760 0.01883       0.8399        0.914
  0.95342    262       1   0.8727 0.01906       0.8361        0.911
  0.96438    260       1   0.8693 0.01928       0.8324        0.908
  0.99178    255       1   0.8659 0.01950       0.8285        0.905
  1.03288    249       1   0.8625 0.01973       0.8246        0.902
  1.04110    247       1   0.8590 0.01996       0.8207        0.899
  1.05479    245       1   0.8555 0.02018       0.8168        0.896
  1.06027    242       1   0.8519 0.02041       0.8129        0.893
  1.07671    241       1   0.8484 0.02062       0.8089        0.890
  1.08219    240       1   0.8449 0.02084       0.8050        0.887
  1.08767    239       1   0.8413 0.02105       0.8011        0.884
  1.10411    237       1   0.8378 0.02126       0.7971        0.880
  1.13425    235       1   0.8342 0.02146       0.7932        0.877
  1.17808    234       1   0.8306 0.02167       0.7892        0.874
  1.18082    233       1   0.8271 0.02187       0.7853        0.871
  1.23562    227       1   0.8234 0.02207       0.7813        0.868
  1.24932    226       1   0.8198 0.02227       0.7773        0.865
  1.25753    225       1   0.8161 0.02247       0.7733        0.861
  1.30137    223       1   0.8125 0.02266       0.7693        0.858
  1.31233    222       1   0.8088 0.02286       0.7652        0.855
  1.31507    221       1   0.8052 0.02304       0.7612        0.852
  1.32877    220       1   0.8015 0.02323       0.7572        0.848
  1.39726    215       1   0.7978 0.02342       0.7532        0.845
  1.42740    211       2   0.7902 0.02380       0.7449        0.838
  1.45205    209       1   0.7864 0.02398       0.7408        0.835
  1.49315    208       1   0.7827 0.02416       0.7367        0.831
  1.51233    206       1   0.7789 0.02434       0.7326        0.828
  1.53973    204       1   0.7750 0.02452       0.7284        0.825
  1.56712    202       2   0.7674 0.02487       0.7201        0.818
  1.58356    200       1   0.7635 0.02504       0.7160        0.814
  1.58904    197       1   0.7597 0.02521       0.7118        0.811
  1.72877    192       1   0.7557 0.02539       0.7075        0.807
  1.74521    191       1   0.7517 0.02556       0.7033        0.804
  1.75616    189       1   0.7478 0.02573       0.6990        0.800
  1.81644    187       1   0.7438 0.02591       0.6947        0.796
  1.87123    185       1   0.7397 0.02608       0.6904        0.793
  1.92055    180       1   0.7356 0.02625       0.6859        0.789
  1.94247    179       1   0.7315 0.02643       0.6815        0.785
  1.99178    175       1   0.7273 0.02660       0.6770        0.781
  2.09041    172       1   0.7231 0.02678       0.6725        0.778
  2.10411    171       1   0.7189 0.02696       0.6679        0.774
  2.10959    170       1   0.7147 0.02713       0.6634        0.770
  2.11781    169       1   0.7104 0.02730       0.6589        0.766
  2.14247    167       1   0.7062 0.02746       0.6543        0.762
  2.20274    166       1   0.7019 0.02762       0.6498        0.758
  2.24384    165       1   0.6977 0.02778       0.6453        0.754
  2.25479    163       1   0.6934 0.02794       0.6407        0.750
  2.28493    162       1   0.6891 0.02809       0.6362        0.746
  2.29863    161       1   0.6848 0.02824       0.6316        0.742
  2.41644    160       1   0.6805 0.02839       0.6271        0.739
  2.42466    159       1   0.6763 0.02853       0.6226        0.735
  2.53973    154       2   0.6675 0.02883       0.6133        0.726
  2.61096    150       1   0.6630 0.02898       0.6086        0.722
  2.71781    148       1   0.6586 0.02913       0.6039        0.718
  2.72055    147       1   0.6541 0.02927       0.5991        0.714
  2.73425    146       1   0.6496 0.02941       0.5944        0.710
  2.84110    143       1   0.6450 0.02955       0.5896        0.706
  2.96164    141       1   0.6405 0.02970       0.5848        0.701
  2.98904    140       1   0.6359 0.02983       0.5800        0.697
  3.00548    138       1   0.6313 0.02997       0.5752        0.693
  3.07123    137       1   0.6267 0.03011       0.5704        0.689
  3.10411    135       1   0.6220 0.03024       0.5655        0.684
  3.10685    134       1   0.6174 0.03037       0.5607        0.680
  3.36986    127       1   0.6125 0.03051       0.5556        0.675
  3.47945    125       1   0.6076 0.03066       0.5504        0.671
  3.53151    123       1   0.6027 0.03081       0.5452        0.666
  4.33973     96       1   0.5964 0.03112       0.5384        0.661
  4.35616     94       1   0.5901 0.03143       0.5316        0.655
  4.41096     93       1   0.5837 0.03172       0.5247        0.649
  4.45205     91       1   0.5773 0.03202       0.5179        0.644
  4.49041     90       1   0.5709 0.03230       0.5110        0.638
  4.49589     89       1   0.5645 0.03257       0.5041        0.632
  4.53973     88       1   0.5581 0.03282       0.4973        0.626
  4.55068     86       1   0.5516 0.03308       0.4904        0.620
  4.69589     83       1   0.5449 0.03334       0.4834        0.614
  4.70685     82       1   0.5383 0.03359       0.4763        0.608
  4.72329     81       1   0.5316 0.03382       0.4693        0.602
  4.74521     79       1   0.5249 0.03406       0.4622        0.596
  5.38082     61       1   0.5163 0.03457       0.4528        0.589
  5.87671     52       1   0.5064 0.03530       0.4417        0.581
  5.93425     49       1   0.4960 0.03606       0.4302        0.572
  6.10137     46       1   0.4853 0.03686       0.4181        0.563
  6.13973     45       1   0.4745 0.03758       0.4063        0.554
  6.41918     38       1   0.4620 0.03861       0.3922        0.544
  6.53699     37       1   0.4495 0.03953       0.3783        0.534
  7.02466     32       1   0.4355 0.04072       0.3625        0.523
  7.44384     30       1   0.4209 0.04187       0.3464        0.512
  7.53973     27       1   0.4054 0.04312       0.3291        0.499
  7.57260     26       1   0.3898 0.04419       0.3121        0.487
 12.82192      4       1   0.2923 0.09066       0.1592        0.537
 13.04110      3       1   0.1949 0.09991       0.0713        0.532
 13.30411      2       1   0.0974 0.08511       0.0176        0.540
 14.11507      1       1   0.0000     NaN           NA           NA

                gender=MALE 
     time n.risk n.event survival std.err lower 95% CI upper 95% CI
  0.00548    719       2    0.997 0.00196        0.993        1.000
  0.03014    716       1    0.996 0.00241        0.991        1.000
  0.03836    713       1    0.994 0.00278        0.989        1.000
  0.04932    711       1    0.993 0.00311        0.987        0.999
  0.11233    706       1    0.992 0.00341        0.985        0.998
  0.11507    705       1    0.990 0.00368        0.983        0.997
  0.11781    704       1    0.989 0.00393        0.981        0.997
  0.16164    700       1    0.987 0.00417        0.979        0.996
  0.16986    699       2    0.985 0.00462        0.976        0.994
  0.17808    697       1    0.983 0.00482        0.974        0.993
  0.18904    696       2    0.980 0.00520        0.970        0.991
  0.20822    694       1    0.979 0.00538        0.968        0.990
  0.22466    692       1    0.978 0.00556        0.967        0.988
  0.23562    691       1    0.976 0.00573        0.965        0.987
  0.24384    690       1    0.975 0.00589        0.963        0.986
  0.25479    688       1    0.973 0.00605        0.961        0.985
  0.26027    687       1    0.972 0.00621        0.960        0.984
  0.27123    686       1    0.970 0.00636        0.958        0.983
  0.27671    685       1    0.969 0.00650        0.956        0.982
  0.29041    683       1    0.968 0.00665        0.955        0.981
  0.29315    682       1    0.966 0.00679        0.953        0.980
  0.29589    681       1    0.965 0.00692        0.951        0.978
  0.30137    680       1    0.963 0.00706        0.950        0.977
  0.30685    679       1    0.962 0.00719        0.948        0.976
  0.34521    676       1    0.960 0.00732        0.946        0.975
  0.35342    674       2    0.958 0.00757        0.943        0.973
  0.35616    672       1    0.956 0.00769        0.941        0.971
  0.37534    670       1    0.955 0.00781        0.940        0.970
  0.38082    669       1    0.953 0.00793        0.938        0.969
  0.38904    668       1    0.952 0.00804        0.936        0.968
  0.39452    667       1    0.951 0.00816        0.935        0.967
  0.43836    663       1    0.949 0.00827        0.933        0.965
  0.44384    662       1    0.948 0.00838        0.931        0.964
  0.44932    661       1    0.946 0.00849        0.930        0.963
  0.45479    660       1    0.945 0.00860        0.928        0.962
  0.46027    658       1    0.943 0.00870        0.926        0.961
  0.47397    657       1    0.942 0.00881        0.925        0.959
  0.49863    654       1    0.940 0.00891        0.923        0.958
  0.53151    650       1    0.939 0.00901        0.922        0.957
  0.53973    648       1    0.938 0.00912        0.920        0.956
  0.54247    647       1    0.936 0.00922        0.918        0.954
  0.55890    646       1    0.935 0.00931        0.917        0.953
  0.56164    644       1    0.933 0.00941        0.915        0.952
  0.56438    642       1    0.932 0.00951        0.913        0.951
  0.57808    639       1    0.930 0.00961        0.912        0.949
  0.58904    637       1    0.929 0.00970        0.910        0.948
  0.59452    635       2    0.926 0.00989        0.907        0.946
  0.59726    633       1    0.924 0.00998        0.905        0.944
  0.60822    632       2    0.922 0.01016        0.902        0.942
  0.67123    627       1    0.920 0.01025        0.900        0.940
  0.69315    626       1    0.919 0.01034        0.899        0.939
  0.70137    624       1    0.917 0.01043        0.897        0.938
  0.70959    623       1    0.916 0.01051        0.895        0.936
  0.71507    622       1    0.914 0.01060        0.894        0.935
  0.75068    621       1    0.913 0.01068        0.892        0.934
  0.75616    620       1    0.911 0.01077        0.890        0.933
  0.76438    618       1    0.910 0.01085        0.889        0.931
  0.76986    617       1    0.908 0.01093        0.887        0.930
  0.77260    616       1    0.907 0.01101        0.885        0.929
  0.77534    615       1    0.905 0.01109        0.884        0.927
  0.77808    614       1    0.904 0.01117        0.882        0.926
  0.80000    613       1    0.902 0.01125        0.881        0.925
  0.80822    611       1    0.901 0.01133        0.879        0.923
  0.84110    610       1    0.899 0.01141        0.877        0.922
  0.85205    609       1    0.898 0.01148        0.876        0.921
  0.85753    607       2    0.895 0.01164        0.872        0.918
  0.86849    605       2    0.892 0.01178        0.869        0.915
  0.87671    601       1    0.891 0.01186        0.868        0.914
  0.87945    600       1    0.889 0.01193        0.866        0.913
  0.89589    598       2    0.886 0.01207        0.863        0.910
  0.90411    596       2    0.883 0.01221        0.860        0.907
  0.91233    594       1    0.882 0.01228        0.858        0.906
  0.91507    593       1    0.880 0.01235        0.856        0.905
  0.92055    592       1    0.879 0.01242        0.855        0.903
  0.92329    591       1    0.877 0.01249        0.853        0.902
  0.93425    589       1    0.876 0.01256        0.851        0.901
  0.93699    588       2    0.873 0.01269        0.848        0.898
  0.96164    585       1    0.871 0.01276        0.847        0.897
  0.96712    584       1    0.870 0.01282        0.845        0.895
  0.97808    583       1    0.868 0.01288        0.843        0.894
  0.98356    581       1    0.867 0.01295        0.842        0.892
  0.98630    580       1    0.865 0.01301        0.840        0.891
  0.98904    578       1    0.864 0.01308        0.838        0.890
  1.00274    575       1    0.862 0.01314        0.837        0.888
  1.01644    571       1    0.861 0.01320        0.835        0.887
  1.02740    569       1    0.859 0.01327        0.834        0.886
  1.03288    567       1    0.858 0.01333        0.832        0.884
  1.03836    565       1    0.856 0.01339        0.830        0.883
  1.05205    564       1    0.855 0.01345        0.829        0.881
  1.05479    563       1    0.853 0.01351        0.827        0.880
  1.08219    556       1    0.852 0.01358        0.825        0.879
  1.10411    554       1    0.850 0.01364        0.824        0.877
  1.11233    552       1    0.849 0.01370        0.822        0.876
  1.11507    550       1    0.847 0.01376        0.820        0.874
  1.13699    546       1    0.845 0.01383        0.819        0.873
  1.16164    543       1    0.844 0.01389        0.817        0.872
  1.16986    541       1    0.842 0.01395        0.815        0.870
  1.19452    539       1    0.841 0.01401        0.814        0.869
  1.21918    537       1    0.839 0.01407        0.812        0.867
  1.22192    536       2    0.836 0.01419        0.809        0.864
  1.23014    534       1    0.835 0.01425        0.807        0.863
  1.24110    533       1    0.833 0.01431        0.805        0.861
  1.24384    532       1    0.831 0.01437        0.804        0.860
  1.25753    529       1    0.830 0.01443        0.802        0.859
  1.26575    527       1    0.828 0.01449        0.800        0.857
  1.27123    526       1    0.827 0.01454        0.799        0.856
  1.29315    522       1    0.825 0.01460        0.797        0.854
  1.30959    521       1    0.823 0.01466        0.795        0.853
  1.31507    519       2    0.820 0.01477        0.792        0.850
  1.32603    517       1    0.819 0.01483        0.790        0.848
  1.33425    515       1    0.817 0.01489        0.788        0.847
  1.33973    514       1    0.816 0.01494        0.787        0.845
  1.35068    512       1    0.814 0.01500        0.785        0.844
  1.35616    511       1    0.812 0.01505        0.783        0.842
  1.38630    508       1    0.811 0.01511        0.782        0.841
  1.43014    503       1    0.809 0.01516        0.780        0.839
  1.44110    501       1    0.808 0.01522        0.778        0.838
  1.48767    497       1    0.806 0.01527        0.777        0.836
  1.49589    495       2    0.803 0.01539        0.773        0.833
  1.50137    492       1    0.801 0.01544        0.771        0.832
  1.53425    489       1    0.799 0.01550        0.770        0.830
  1.53699    488       2    0.796 0.01560        0.766        0.827
  1.54247    486       1    0.794 0.01566        0.764        0.826
  1.54521    484       1    0.793 0.01571        0.763        0.824
  1.56438    482       1    0.791 0.01576        0.761        0.823
  1.57260    480       1    0.790 0.01582        0.759        0.821
  1.58082    477       2    0.786 0.01592        0.756        0.818
  1.60000    475       1    0.785 0.01598        0.754        0.817
  1.60822    474       1    0.783 0.01603        0.752        0.815
  1.64384    471       1    0.781 0.01608        0.750        0.813
  1.64658    470       1    0.780 0.01613        0.749        0.812
  1.64932    469       1    0.778 0.01618        0.747        0.810
  1.66027    466       1    0.776 0.01623        0.745        0.809
  1.70959    457       1    0.775 0.01629        0.743        0.807
  1.71233    455       1    0.773 0.01634        0.741        0.806
  1.76712    446       1    0.771 0.01639        0.740        0.804
  1.76986    443       1    0.769 0.01645        0.738        0.802
  1.79178    440       1    0.768 0.01650        0.736        0.801
  1.82466    436       1    0.766 0.01656        0.734        0.799
  1.84932    434       1    0.764 0.01662        0.732        0.797
  1.86027    433       1    0.762 0.01667        0.730        0.796
  1.86301    431       1    0.761 0.01673        0.728        0.794
 [ reached getOption("max.print") -- omitted 99 rows ]
```



---
 
 
##  Kaplan-Meier estimates and curves: Estimating x-year survival


```r
summary(survfit(OS_obj ~ gender, data = tcga), times = 5, extend=TRUE)
```

```
Call: survfit(formula = OS_obj ~ gender, data = tcga)

1 observation deleted due to missingness 
                gender=FEMALE 
        time       n.risk      n.event     survival      std.err 
      5.0000      70.0000     118.0000       0.5249       0.0341 
lower 95% CI upper 95% CI 
      0.4622       0.5961 

                gender=MALE 
        time       n.risk      n.event     survival      std.err 
      5.0000     135.0000     230.0000       0.5759       0.0236 
lower 95% CI upper 95% CI 
      0.5314       0.6240 
```

---
--- 

## Plot code
 
p &lt;-  ggsurvplot(kmfit, data = tcga,
           # Add median survival lines
           surv.median.line = "hv", 
           # Change legends: title &amp; labels
           title= "Overall Survival by gender", 
           xlab ="Years", legend.labs = c("Female","Male"  ),
           # Add p-value and CIs
           pval = FALSE,
           conf.int = FALSE,
           # Add risk table
           risk.table = TRUE, tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           # Color palettes.
           palette = c("Red","Blue" ) 
           # Change ggplot2 theme
           ggtheme = theme_bw(), 
           risk.table.title = "Number at risk") 
 
---
 
 
&lt;img src="Lecture7slides_files/figure-html/KMplotdisplay -1.png" width="100%" /&gt;

---
 
# Log rank test
  
The log rank test is a hypothesis test to compare the 
survival distributions of two or more samples. 

- Nonparametric test and appropriate to use when the data are 
right skewed and censored. 

- Widely used in clinical trials to establish the efficacy of 
a new treatment in comparison with a control treatment when the
measurement is the time to event.

The test is sometimes called the Mantel–Cox test, named after 
Nathan Mantel and David Cox. The logrank test can also be viewed 
as a time-stratified Cochran–Mantel–Haenszel test.
  

---
 
## Log rank test

The logrank test is used to test the null hypothesis that there is no
difference between the populations in the probability of an event 
(death) at any time point. The analysis is based on the times 
of events (deaths). For each such time we calculate the observed
number of deaths in each group and the number expected if there were 
in reality no difference between the groups.

---
 
## Log rank test: test statistic

 
We can now use a `\(\chi ^{2}\)` test of the null hypothesis.  

Test statisic = `\(\frac{\sum_{it}(O_{ij} - E_{ij})^{2}}{var(\sum_{1}^{k}(O_{ij}-E_{ij}))}\)` 
for each group, where O and E are the totals of the observed and expected events at the time of each event. 

- i, denotes the group; j denotes the time that the event occurred,
- `\(O_{ij}\)`, number of observed events in the ith group at the jth time period,
- `\(E_{ij}\)`, number of expected events in the ith group at the j th time period.
 
---
 
## Log rank test: test statistic

- `\(O_{ij}\)` = `\(\sum_{j=1}^{K}d_{ij}\)`

- `\(E_{ij}\)` = `\(\sum_{j=1}^{K}d_{ij}\frac{r_{ij}}{r_j}\)`

Test statistic = `\(\frac{(\sum_{j}(d_{ij}-d_{j}\frac{r_{ij}}{r_{j}})))^{2}}{\sum_{j=1}^k\frac{r_{1j}r_{2j}d_{j}(r_{j}-d_{j}) }{r_{j}^{2}(r_{j}-1) }}\)`

 



---
 
## Log rank test
  
  The logrank test is based on the same assumptions as the Kaplan Meier 
survival curve, namely, that censoring is unrelated to prognosis, the 
survival probabilities are the same for subjects recruited early and late 
in the study, and the events happened at the times specified. Deviations 
from these assumptions matter most if they are satisfied differently in 
the groups being compared, for example if censoring is more likely in one 
group than another.

Because the logrank test is purely a test of significance it cannot 
provide an estimate of the size of the difference between the groups 
or a confidence interval. 
  
  
---
 
 
 
## Log rank test R code
 

```r
survdiff(OS_obj ~ smoking, data = tcga)
```

```
Call:
survdiff(formula = OS_obj ~ smoking, data = tcga)

n=584, 459 observations deleted due to missingness.

                  N Observed Expected (O-E)^2/E (O-E)^2/V
smoking=Current 190       82     61.3     7.017     9.945
smoking=Former  234       92     98.6     0.444     0.823
smoking=Never   160       49     63.1     3.157     4.463

 Chisq= 10.8  on 2 degrees of freedom, p= 0.004 
```





 



---

# Kaplan-Meier plots


---
 
 
&lt;img src="Lecture7slides_files/figure-html/KMplotcodeagain-1.png" width="100%" /&gt;
  
 
---


&lt;img src="Lecture7slides_files/figure-html/KMplotcodefvN-1.png" width="100%" /&gt;
  
---


&lt;img src="Lecture7slides_files/figure-html/KMplotcodeCvF-1.png" width="100%" /&gt;
  
---

&lt;img src="Lecture7slides_files/figure-html/KMplotcodeCvN-1.png" width="100%" /&gt;
  
  
  
  

---
 
## Log rank test R code: pair wise comparisions
 
 
.panelset[
.panel[.panel-name[R Code]

 

```r
library(survminer)

tcganonasmoking &lt;- tcga %&gt;% filter(!is.na(smoking)) %&gt;%
  mutate(  OS_objs = survival::Surv( OS.time/365, I( vital_status=="Dead")) )
```
]

.panel[.panel-name[R Result]


```r
 pairwise_survdiff(OS_objs ~  smoking, data = tcganonasmoking, 
                   p.adjust.method = "none", rho = 0)
```

```

	Pairwise comparisons using Log-Rank test 

data:  tcganonasmoking and smoking 

       Current Former
Former 0.0131  -     
Never  0.0031  0.2900

P value adjustment method: none 
```
]


]



---

&lt;img src="Lecture7slides_files/figure-html/KMplotcodeCvNcb-1.png" width="100%" /&gt;
  

---





## Thank you! 
  
  - The end

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="libs/remark-0.14.0.min.js"></script>
<script>var slideshow = remark.create({
"slideNumberFormat": "%current%",
"highlightStyle": "atom-one-light",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
